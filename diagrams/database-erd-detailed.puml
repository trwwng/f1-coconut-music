@startuml Coconut_Music_Database_ERD
!define TABLE(name,desc) class name as "desc" << (T,#FFAAAA) >>
!define PRIMARY_KEY(x) <b><color:#b8861b><&key></color> x</b>
!define FOREIGN_KEY(x) <color:#aaaaaa><&arrow-right></color> x
!define UNIQUE(x) <color:#green><&asterisk></color> x
!define NOT_NULL(x) <color:#red>x</color>

title Coconut Music Platform - Database Entity Relationship Diagram

' Define color scheme
skinparam class {
    BackgroundColor LightBlue
    BorderColor DarkBlue
    ArrowColor DarkBlue
}

skinparam note {
    BackgroundColor LightYellow
    BorderColor Orange
}

' Users Table - Central entity
TABLE(users, "üßë‚Äçüíº USERS\n(Ng∆∞·ªùi d√πng)") {
    PRIMARY_KEY(id: BIGINT)
    --
    NOT_NULL(username: VARCHAR(255))
    NOT_NULL(email: VARCHAR(255))
    NOT_NULL(password: VARCHAR(255))
    is_admin: BIT(1)
    is_verified: BIT(1)
    avatar_url: VARCHAR(255)
    forgot_password_token: VARCHAR(255)
    forgot_password_token_expiry: DATETIME(6)
    verify_token: VARCHAR(255)
    verify_token_expiry: DATETIME(6)
    created_at: DATETIME(6)
    updated_at: DATETIME(6)
    --
    UNIQUE(email)
    UNIQUE(username)
}

' Artists Table
TABLE(artists, "üé§ ARTISTS\n(Ngh·ªá sƒ©)") {
    PRIMARY_KEY(id: BIGINT)
    --
    NOT_NULL(name: VARCHAR(255))
    bio: TEXT
    avatar_url: VARCHAR(255)
    is_active: BIT(1)
    created_at: DATETIME(6)
    updated_at: DATETIME(6)
}

' Categories Table
TABLE(categories, "üìÇ CATEGORIES\n(Th·ªÉ lo·∫°i)") {
    PRIMARY_KEY(id: BIGINT)
    --
    NOT_NULL(name: VARCHAR(255))
    description: TEXT
    image_url: VARCHAR(255)
    is_active: BIT(1)
    created_at: DATETIME(6)
    updated_at: DATETIME(6)
    --
    UNIQUE(name)
}

' Music Table - Core content entity
TABLE(music, "üéµ MUSIC\n(B√†i nh·∫°c)") {
    PRIMARY_KEY(id: BIGINT)
    --
    NOT_NULL(title: VARCHAR(255))
    NOT_NULL(file_url: VARCHAR(255))
    image_url: VARCHAR(255)
    NOT_NULL(duration_seconds: INT)
    play_count: BIGINT
    like_count: BIGINT
    is_active: BIT(1)
    type_music: ENUM
    created_at: DATETIME(6)
    updated_at: DATETIME(6)
    --
    FOREIGN_KEY(artist_id: BIGINT)
    FOREIGN_KEY(category_id: BIGINT)
    FOREIGN_KEY(uploaded_by: BIGINT)
}

' Playlists Table
TABLE(playlists, "üéß PLAYLISTS\n(Danh s√°ch ph√°t)") {
    PRIMARY_KEY(id: BIGINT)
    --
    NOT_NULL(name: VARCHAR(255))
    description: TEXT
    image_url: VARCHAR(255)
    is_public: BIT(1)
    created_at: DATETIME(6)
    updated_at: DATETIME(6)
    --
    FOREIGN_KEY(user_id: BIGINT)
}

' Playlist Music Junction Table
TABLE(playlist_music, "üîó PLAYLIST_MUSIC\n(Nh·∫°c trong playlist)") {
    PRIMARY_KEY(id: BIGINT)
    --
    position: INT
    added_at: DATETIME(6)
    --
    FOREIGN_KEY(playlist_id: BIGINT)
    FOREIGN_KEY(music_id: BIGINT)
    --
    UNIQUE(playlist_id, music_id)
}

' Favorites Junction Table
TABLE(favorites, "‚ù§Ô∏è FAVORITES\n(Y√™u th√≠ch)") {
    PRIMARY_KEY(id: BIGINT)
    --
    created_at: DATETIME(6)
    --
    FOREIGN_KEY(user_id: BIGINT)
    FOREIGN_KEY(music_id: BIGINT)
    --
    UNIQUE(user_id, music_id)
}

' History Table
TABLE(history, "üìä HISTORY\n(L·ªãch s·ª≠ nghe)") {
    PRIMARY_KEY(id: BIGINT)
    --
    played_at: DATETIME(6)
    --
    FOREIGN_KEY(user_id: BIGINT)
    FOREIGN_KEY(music_id: BIGINT)
}

' Favorite Playlists Junction Table
TABLE(favorite_playlists, "üíñ FAVORITE_PLAYLISTS\n(Playlist y√™u th√≠ch)") {
    PRIMARY_KEY(id: BIGINT)
    --
    created_at: DATETIME(6)
    --
    FOREIGN_KEY(user_id: BIGINT)
    FOREIGN_KEY(playlist_id: BIGINT)
    --
    UNIQUE(user_id, playlist_id)
}

' Banners Table - Standalone
TABLE(banners, "üé™ BANNERS\n(Banner qu·∫£ng c√°o)") {
    PRIMARY_KEY(id: BIGINT)
    --
    NOT_NULL(title: VARCHAR(255))
    NOT_NULL(image_url: VARCHAR(255))
    link_url: VARCHAR(255)
    is_active: BIT(1)
    sort_order: INT
    created_at: DATETIME(6)
    updated_at: DATETIME(6)
}

' Relationships - One to Many
users ||--o{ playlists : "user_id"
users ||--o{ history : "user_id"
users ||--o{ favorites : "user_id"
users ||--o{ favorite_playlists : "user_id"
users ||--o{ music : "uploaded_by"

artists ||--o{ music : "artist_id"
categories ||--o{ music : "category_id"

playlists ||--o{ playlist_music : "playlist_id"
playlists ||--o{ favorite_playlists : "playlist_id"

music ||--o{ playlist_music : "music_id"
music ||--o{ favorites : "music_id"
music ||--o{ history : "music_id"

' Notes explaining key concepts
note top of users : "**üë§ USERS - Trung t√¢m h·ªá th·ªëng**\n‚Ä¢ Admin c√≥ quy·ªÅn qu·∫£n l√Ω to√†n b·ªô\n‚Ä¢ User th∆∞·ªùng c√≥ th·ªÉ t·∫°o playlist\n‚Ä¢ X√°c th·ª±c email qua verify_token\n‚Ä¢ Reset password qua forgot_password_token"

note top of music : "**üéµ MUSIC - N·ªôi dung ch√≠nh**\n‚Ä¢ 5 lo·∫°i: NEW_MUSIC, TRENDING,\n  TOP_VIEW, VN_LOFI, FAVORITE\n‚Ä¢ Tracking play_count & like_count\n‚Ä¢ File audio l∆∞u tr√™n Firebase\n‚Ä¢ M·ªói b√†i nh·∫°c thu·ªôc 1 artist & 1 category"

note top of playlist_music : "**üîó MANY-TO-MANY**\n‚Ä¢ 1 Playlist ch·ª©a nhi·ªÅu Music\n‚Ä¢ 1 Music c√≥ th·ªÉ trong nhi·ªÅu Playlist\n‚Ä¢ Position x√°c ƒë·ªãnh th·ª© t·ª±\n‚Ä¢ Unique constraint ngƒÉn tr√πng l·∫∑p"

note top of favorites : "**‚ù§Ô∏è USER INTERACTIONS**\n‚Ä¢ User c√≥ th·ªÉ y√™u th√≠ch Music\n‚Ä¢ User c√≥ th·ªÉ y√™u th√≠ch Playlist\n‚Ä¢ History tracking m·ªçi l·∫ßn nghe\n‚Ä¢ Unique constraints ngƒÉn spam"

note bottom of banners : "**üé™ STANDALONE TABLE**\n‚Ä¢ Qu·∫£n l√Ω banner/qu·∫£ng c√°o\n‚Ä¢ Kh√¥ng li√™n k·∫øt v·ªõi b·∫£ng kh√°c\n‚Ä¢ Sort_order cho th·ª© t·ª± hi·ªÉn th·ªã\n‚Ä¢ Link_url cho ƒëi·ªÅu h∆∞·ªõng"

' Additional relationship notes
note on link : users to music : "1:N\nUser upload nh·∫°c"
note on link : users to playlists : "1:N\nUser t·∫°o playlist"
note on link : users to favorites : "1:N\nUser y√™u th√≠ch nh·∫°c"
note on link : users to history : "1:N\nL·ªãch s·ª≠ nghe nh·∫°c"
note on link : artists to music : "1:N\nNgh·ªá sƒ© s√°ng t√°c nh·∫°c"
note on link : categories to music : "1:N\nTh·ªÉ lo·∫°i ch·ª©a nh·∫°c"
note on link : playlists to playlist_music : "1:N\nPlaylist ch·ª©a nh·∫°c"
note on link : music to playlist_music : "1:N\nNh·∫°c trong playlist"

' Legend
legend top right
    |= K√Ω hi·ªáu |= √ù nghƒ©a |
    | <b><color:#b8861b><&key></color></b> | Primary Key |
    | <color:#aaaaaa><&arrow-right></color> | Foreign Key |
    | <color:#green><&asterisk></color> | Unique Constraint |
    | <color:#red>‚ñ†</color> | Not Null |
    | BIT(1) | Boolean (0/1) |
    | ENUM | NEW_MUSIC, TRENDING, TOP_VIEW, VN_LOFI, FAVORITE |
endlegend

' Database statistics
note bottom : "**üìà TH·ªêNG K√ä DATABASE**\n\
‚Ä¢ **10 b·∫£ng** trong h·ªá th·ªëng\n\
‚Ä¢ **6 b·∫£ng ch√≠nh**: users, music, artists, categories, playlists, banners\n\
‚Ä¢ **4 b·∫£ng li√™n k·∫øt**: playlist_music, favorites, history, favorite_playlists\n\
‚Ä¢ **15 foreign key** relationships\n\
‚Ä¢ **6 unique constraints** ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn\n\
‚Ä¢ **Support**: User management, Content management, Social features"

@enduml
